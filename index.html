<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Live Korean → English (Subtitles + Audio, Backend)</title><style>:root{color-scheme:dark;--bg:#020617;--panel:#020617;--border:#1f2937;--muted:#9ca3af;}*{box-sizing:border-box;}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:#e5e7eb;}header{padding:12px 16px;background:#020617;border-bottom:1px solid var(--border);}main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:12px;grid-template-columns:1.25fr .75fr;}@media(max-width:980px){main{grid-template-columns:1fr;}}.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}input,button,select{background:#020617;color:#e5e7eb;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font:inherit;}button{cursor:pointer;}button:disabled{opacity:.5;cursor:not-allowed;}.muted{color:var(--muted);font-size:.92rem;}pre{margin:0;white-space:pre-wrap;word-break:break-word;font-size:.83rem;}.pill{font-size:12px;padding:2px 10px;border:1px solid #374151;border-radius:999px;color:#d1d5db;}.playerWrap{position:relative;border-radius:18px;overflow:hidden;border:1px solid #0f172a;background:#000;}video{width:100%;max-height:72vh;background:#000;display:block;}.subOverlay{position:absolute;left:0;right:0;bottom:10%;display:flex;justify-content:center;padding:0 16px;pointer-events:none;text-align:center;text-shadow:0 3px 14px rgba(0,0,0,.95);font-weight:750;}.subBubble{max-width:95%;padding:8px 14px;border-radius:14px;background:radial-gradient(circle at top,rgba(15,23,42,.88),rgba(0,0,0,.95));border:1px solid rgba(148,163,184,.45);line-height:1.35;white-space:pre-wrap;}.badgeRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}.dot{width:8px;height:8px;border-radius:999px;background:#10b981;}.dot.red{background:#ef4444;}.dot.yellow{background:#facc15;}</style></head><body><header><div class="row" style="justify-content:space-between;"><div><div style="font-weight:800;">Live Korean → English (Backend: Whisper + TTS)</div><div class="muted">Korean audio → server (Whisper translate + TTS) → English subtitles + English audio overlay.</div></div><span id="badge" class="pill">Idle</span></div></header><main><section class="card"><div class="row"><input id="file" type="file" accept="video/*,audio/*,.mkv"><button id="btnStart" disabled>Start live translate</button><button id="btnStop" disabled>Stop</button><button id="btnClear" disabled>Clear video</button></div><div class="row" style="margin-top:10px;"><span class="muted">Chunk sec</span><select id="chunkSec"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select><span class="muted">Hold subtitle</span><select id="holdSec"><option value="2">2s</option><option value="3" selected>3s</option><option value="4">4s</option></select><span class="muted">Font</span><select id="fontSize"><option value="18">18px</option><option value="22" selected>22px</option><option value="26">26px</option></select><span class="muted">Pos</span><select id="pos"><option value="6">Low</option><option value="10" selected>Normal</option><option value="16">High</option></select></div><div class="muted" style="margin-top:8px;">This version records mic audio, streams chunks to <code>/api/chunk</code>. Server calls Whisper translate + TTS, returns English text + English audio URL.</div><div style="margin-top:14px;" class="playerWrap"><video id="video" controls playsinline preload="metadata"></video><div class="subOverlay" id="subOverlay"><div class="subBubble" id="subText"></div></div></div></section><aside class="card"><div class="row" style="justify-content:space-between;"><div class="badgeRow"><span id="dot" class="dot"></span><span style="font-weight:700;">Status / Debug</span></div><button id="btnClearSub" type="button">Clear subtitles</button></div><pre id="log" class="muted" style="margin-top:10px;">Waiting…</pre></aside></main><script>(() => {const API_BASE="";const file=document.getElementById('file');const video=document.getElementById('video');const btnStart=document.getElementById('btnStart');const btnStop=document.getElementById('btnStop');const btnClear=document.getElementById('btnClear');const btnClearSub=document.getElementById('btnClearSub');const chunkSec=document.getElementById('chunkSec');const holdSec=document.getElementById('holdSec');const fontSize=document.getElementById('fontSize');const pos=document.getElementById('pos');const log=document.getElementById('log');const badge=document.getElementById('badge');const dot=document.getElementById('dot');const subOverlay=document.getElementById('subOverlay');const subText=document.getElementById('subText');let mediaUrl=null;let isRunning=false;let mediaStream=null;let recorder=null;let overlayTimer=null;let lastText="";function setBadge(text,color){badge.textContent=text;badge.style.borderColor=color||'#374151';}function setDot(state){dot.classList.remove('red','yellow');if(state==='red')dot.classList.add('red');if(state==='yellow')dot.classList.add('yellow');}function setLog(text){log.textContent=text;}function revoke(url){if(url)URL.revokeObjectURL(url);}function applyUiSettings(){subOverlay.style.bottom=pos.value+'%';subText.parentElement.style.fontSize=fontSize.value+'px';}fontSize.addEventListener('change',applyUiSettings);pos.addEventListener('change',applyUiSettings);applyUiSettings();function showSubtitle(text){subText.textContent=text;if(overlayTimer)clearTimeout(overlayTimer);const ms=(Number(holdSec.value)||3)*1000;overlayTimer=setTimeout(()=>{if(subText.textContent===text)subText.textContent='';}ms);}btnClearSub.addEventListener('click',()=>{if(overlayTimer)clearTimeout(overlayTimer);subText.textContent='';lastText="";setLog('Subtitles cleared.');});file.addEventListener('change',()=>{const f=file.files&&file.files[0];if(!f)return;stop();if(overlayTimer)clearTimeout(overlayTimer);subText.textContent='';lastText='';revoke(mediaUrl);mediaUrl=URL.createObjectURL(f);video.src=mediaUrl;btnStart.disabled=false;btnClear.disabled=true;setBadge('Loaded','#10b981');setDot('');setLog('Play video first, then click "Start live translate".');});async function start(){if(isRunning)return;if(!video.src){setLog('Load a video first.');return;}try{mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});}catch(err){setBadge('Mic denied','#ef4444');setDot('red');setLog('Microphone permission denied: '+(err.message||err));return;}const options={mimeType:"audio/webm"};try{recorder=new MediaRecorder(mediaStream,options);}catch(err){setBadge('Error','#ef4444');setDot('red');setLog('MediaRecorder error: '+(err.message||err));return;}isRunning=true;btnStart.disabled=true;btnStop.disabled=false;btnClear.disabled=false;setBadge('Streaming…','#60a5fa');setDot('yellow');setLog('Recording mic chunks and sending to server…');recorder.ondataavailable=async(e)=>{if(!isRunning||!e.data||e.data.size===0)return;const fd=new FormData();fd.append('chunk',e.data,'chunk.webm');try{const res=await fetch(API_BASE+'/api/chunk',{method:'POST',body:fd});if(!res.ok){const t=await res.text();throw new Error('Server '+res.status+': '+t);}const data=await res.json();const text=(data&&data.text)||'';const audioUrl=(data&&data.audioUrl)||'';if(text&&text.trim()&&text!==lastText){lastText=text.trim();showSubtitle(lastText);setLog('EN: '+lastText);if(audioUrl){const audio=new Audio(audioUrl);audio.volume=1.0;audio.play().catch(()=>{});}}setBadge('Streaming…','#60a5fa');setDot('yellow');}catch(err){setBadge('Error','#ef4444');setDot('red');setLog('Chunk error: '+(err.message||err));}};recorder.start(Number(chunkSec.value)*1000);}function stop(){isRunning=false;try{recorder&&recorder.state!=='inactive'&&recorder.stop();}catch(e){}try{mediaStream&&mediaStream.getTracks().forEach(t=>t.stop());}catch(e){}recorder=null;mediaStream=null;btnStart.disabled=!video.src;btnStop.disabled=true;btnClear.disabled=!video.src;setBadge('Idle','#374151');setDot('');}btnStart.addEventListener('click',start);btnStop.addEventListener('click',stop);btnClear.addEventListener('click',()=>{stop();if(overlayTimer)clearTimeout(overlayTimer);subText.textContent='';lastText='';revoke(mediaUrl);mediaUrl=null;video.removeAttribute('src');video.load();file.value='';btnStart.disabled=true;btnStop.disabled=true;btnClear.disabled=true;setBadge('Idle');setDot('');setLog('Cleared.');});window.addEventListener('beforeunload',()=>revoke(mediaUrl));})();</script></body></html>
